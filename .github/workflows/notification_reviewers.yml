name: Review Reminder

on:
  workflow_dispatch:
  schedule:
    # 火曜日の AM10:00 に実行
    - cron: '0 1 * * 2'

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get open pull requests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/pulls \
              | jq '[.[] | select(.requested_reviewers | length > 0) | {number: .number, title: .title, url: .html_url, reviewers: [.requested_reviewers[].login]}]' \
              > pull_request.json
      - name: show json
        run: cat pull_request.json

      - name: Notify reviewers via GitHub comments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -s pull_request.json ]; then
            cat pull_request.json | jq -c '.[]' | while read -r row; do
              pr_number=$(echo "$row" | jq -r '.number')
              pr_title=$(echo "$row" | jq -r '.title')
              reviewers=$(echo "$row" | jq -r '.reviewers | map("@\(. // empty)") | join(" ")')

              # レビュワーが空の場合はスキップ
              if [ -z "$reviewers" ]; then
                echo "PR #${pr_number} にはレビューが完了していないレビュワーは存在しません"
                continue
              fi

              message="${reviewers}\nレビューお願いいたします。"

              # コメントの送信
              response=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"body\": \"$message\"}" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${pr_number}/comments")

              # レスポンスコードを確認
              if [ "$response" -eq 201 ]; then
                echo "PR #${pr_number} へのレビュー依頼が完了しました"
              else
                echo "PR #${pr_number} へのレビュー依頼に失敗しました"
              fi
            done
          else
            echo "レビューが必要なプルリクがありません。"
          fi